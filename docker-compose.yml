version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # Database Layer (MongoDB & Redis)
  # ---------------------------------------------------------------------------
  mongo:
    image: mongo:latest
    container_name: blink-mongo
    ports:
      - "27017:27017" # Exposed for local debugging, consider commenting out in prod
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:alpine
    container_name: blink-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # ---------------------------------------------------------------------------
  # Backend Service (Spring Boot)
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile.chat-service
    container_name: blink-backend
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATA_MONGODB_URI=mongodb://mongo:27017/blink_chat
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - JAVA_OPTS=-XX:MaxRAMPercentage=60.0 -XX:+UseG1GC -XX:MaxGCPauseMillis=50
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus
      # Add your actual API keys here or in a .env file
      - JWT_SECRET=${JWT_SECRET}
      - AI_API_KEY=${AI_API_KEY}
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      - mongo
      - redis

  # ---------------------------------------------------------------------------
  # Frontend Service (React + Nginx)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend-v2
      args:
        # REPLACE THIS WITH YOUR DROPLET IP OR DOMAIN
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:8080}
        - VITE_WS_URL=${VITE_WS_URL:-ws://localhost:8080/ws}
    container_name: blink-frontend
    ports:
      - "80:9091"
    depends_on:
      - backend

volumes:
  mongo_data:
  redis_data:
