name: BlinxAI Chat Service

on:
  push:
    branches: [main]
    paths:
      - "chat-service/**"
      - "Dockerfile.chat-service"
      - "Dockerfile.chat-service.ci"
      - ".github/workflows/chat-service.yaml"
  pull_request:
    branches: [main]
    paths:
      - "chat-service/**"
      - "Dockerfile.chat-service"
      - "Dockerfile.chat-service.ci"
      - ".github/workflows/chat-service.yaml"

env:
  IMAGE_REPO: raajkr07
  IMAGE_NAME: blinx-chat-service
  JAVA_VERSION: "17"

jobs:
  build:
    name: Build, Test & Push
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
      
      - name: Set outputs
        id: vars
        run: echo "sha_short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT

      # ── Java + Maven cache ────────────────────────────────
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven
          cache-dependency-path: chat-service/pom.xml

      # ── Compile + Test + Package in one pass ──────────────
      # Fail-fast: compilation or test failure stops the run.
      - name: Build & Test
        working-directory: chat-service
        run: mvn -B -T 1C verify

      # ── Upload test results (always, even on failure) ─────
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: chat-service/target/surefire-reports/
          retention-days: 7

      # ── Docker (only on push to main) ─────────────────────
      - name: Set up Docker Buildx
        if: github.event_name == 'push'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Copy pre-built JAR into Docker context so the
      # Dockerfile.chat-service can skip the Maven build.
      - name: Prepare Docker context
        if: github.event_name == 'push'
        run: |
          mkdir -p docker-ctx
          cp chat-service/target/*.jar docker-ctx/app.jar
          cp entrypoint.sh docker-ctx/entrypoint.sh

      - name: Build & push image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v5
        with:
          context: docker-ctx
          file: Dockerfile.chat-service.ci
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_REPO }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: chat-service-jar
          path: chat-service/target/*.jar
          retention-days: 1

  # ══════════════════════════════════════════════════════════
  # CD ─ Deploy to Digital Ocean App Platform
  # ══════════════════════════════════════════════════════════
  deploy:
    name: Deploy to Digital Ocean
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production
    concurrency:
      group: digitalocean-deploy
      cancel-in-progress: false

    steps:
      # ── Trigger redeployment via DO API ────────────────────
      - name: Trigger Digital Ocean App Deployment
        id: deploy
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          APP_ID: ${{ secrets.DIGITALOCEAN_APP_ID }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.digitalocean.com/v2/apps/$APP_ID/deployments" \
            -H "Authorization: Bearer $DIGITALOCEAN_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"force_build": true}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            DEPLOYMENT_ID=$(echo "$BODY" | jq -r '.deployment.id // empty')
            echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
            echo "✓ Deployment triggered successfully (ID: $DEPLOYMENT_ID)"
          else
            echo "✗ Failed to trigger deployment (HTTP $HTTP_CODE)"
            exit 1
          fi

      # ── Wait for deployment to become active ───────────────
      - name: Wait for deployment
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          APP_ID: ${{ secrets.DIGITALOCEAN_APP_ID }}
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment_id }}
        run: |
          echo "Waiting for deployment $DEPLOYMENT_ID to complete..."
          for i in $(seq 1 30); do
            PHASE=$(curl -s \
              "https://api.digitalocean.com/v2/apps/$APP_ID/deployments/$DEPLOYMENT_ID" \
              -H "Authorization: Bearer $DIGITALOCEAN_ACCESS_TOKEN" \
              | jq -r '.deployment.phase // "UNKNOWN"')
            
            echo "Attempt $i: phase=$PHASE"
            
            if [ "$PHASE" = "ACTIVE" ]; then
              echo "✓ Deployment is ACTIVE"
              exit 0
            elif [ "$PHASE" = "ERROR" ] || [ "$PHASE" = "CANCELED" ]; then
              echo "✗ Deployment failed with phase: $PHASE"
              exit 1
            fi
            
            sleep 20
          done
          echo "✗ Deployment timed out after 10 minutes"
          exit 1

      # ── Smoke test ────────────────────────────────────────
      - name: Health check
        run: |
          echo "Running health check..."
          sleep 10
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.blinxai.me/actuator/health || true)
            if [ "$STATUS" = "200" ]; then
              echo "✓ App is healthy (HTTP $STATUS)"
              exit 0
            fi
            echo "Attempt $i: status=$STATUS, retrying in 15s..."
            sleep 15
          done
          echo "⚠ Health check didn't return 200, but deployment may still be starting"
          exit 0
