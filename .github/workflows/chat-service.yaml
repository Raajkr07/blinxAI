name: BlinxAI Chat Service

on:
  push:
    branches: [main]
    paths:
      - "chat-service/**"
      - "Dockerfile.chat-service"
      - "Dockerfile.chat-service.ci"
      - ".github/workflows/chat-service.yaml"
  pull_request:
    branches: [main]
    paths:
      - "chat-service/**"
      - "Dockerfile.chat-service"
      - "Dockerfile.chat-service.ci"
      - ".github/workflows/chat-service.yaml"

env:
  IMAGE_REPO: raajkr07
  IMAGE_NAME: blinx-chat-service
  HEROKU_APP: ${{ secrets.HEROKU_APP_NAME }}
  JAVA_VERSION: "17"

jobs:
  build:
    name: Build, Test & Push
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
      
      - name: Set outputs
        id: vars
        run: echo "sha_short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT

      # ── Java + Maven cache ────────────────────────────────
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven
          cache-dependency-path: chat-service/pom.xml

      # ── Compile + Test + Package in one pass ──────────────
      # Fail-fast: compilation or test failure stops the run.
      - name: Build & Test
        working-directory: chat-service
        run: mvn -B -T 1C verify

      # ── Upload test results (always, even on failure) ─────
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: chat-service/target/surefire-reports/
          retention-days: 7

      # ── Docker (only on push to main) ─────────────────────
      - name: Set up Docker Buildx
        if: github.event_name == 'push'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Copy pre-built JAR into Docker context so the
      # Dockerfile.chat-service can skip the Maven build.
      - name: Prepare Docker context
        if: github.event_name == 'push'
        run: mkdir -p docker-ctx && cp chat-service/target/*.jar docker-ctx/app.jar

      - name: Build & push image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v5
        with:
          context: docker-ctx
          file: Dockerfile.chat-service.ci
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_REPO }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ══════════════════════════════════════════════════════════
  # CD ─ Deploy to Heroku via Container Registry
  # ══════════════════════════════════════════════════════════
  deploy:
    name: Deploy to Heroku
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production
    concurrency:
      group: heroku-deploy
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      # Re-use the JAR already tested & built in the build job
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven
          cache-dependency-path: chat-service/pom.xml

      - name: Package (skip tests – already passed)
        working-directory: chat-service
        run: mvn -B -T 1C package -DskipTests

      - name: Prepare Docker context
        run: mkdir -p docker-ctx && cp chat-service/target/*.jar docker-ctx/app.jar

      # ── Login to Heroku Container Registry ────────────────
      - name: Login to Heroku Container Registry
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "$HEROKU_API_KEY" | docker login --username=_ --password-stdin registry.heroku.com

      # ── Build & Push to Heroku ────────────────────────────
      - name: Build Heroku image
        run: |
          docker build -t registry.heroku.com/${{ env.HEROKU_APP }}/web \
            -f Dockerfile.chat-service.ci docker-ctx

      - name: Push to Heroku
        run: docker push registry.heroku.com/${{ env.HEROKU_APP }}/web

      # ── Release (via Heroku API – no CLI needed) ──────────
      - name: Release
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          # Get the image ID from Heroku registry
          IMAGE_ID=$(docker inspect registry.heroku.com/${{ env.HEROKU_APP }}/web --format='{{.Id}}')
          # Trigger release via Heroku Platform API
          curl -s -X PATCH https://api.heroku.com/apps/${{ env.HEROKU_APP }}/formation \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.heroku+json; version=3.docker-releases" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -d "{\"updates\": [{\"type\": \"web\", \"docker_image\": \"$IMAGE_ID\"}]}"

      # ── Smoke test ────────────────────────────────────────
      - name: Wait for deploy & health check
        run: |
          echo "Waiting 60s for dyno to start..."
          sleep 60
          for i in 1 2 3 4 5 6; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.blinxai.me/actuator/info || true)
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "404" ] || [ "$STATUS" = "401" ] || [ "$STATUS" = "403" ]; then
              echo "✓ App is responding (HTTP $STATUS)"
              exit 0
            fi
            echo "Attempt $i: status=$STATUS, retrying in 20s..."
            sleep 20
          done
          echo "✗ App not responding after 6 attempts (last status=$STATUS)"
          echo "Check logs: heroku logs --tail --app ${{ env.HEROKU_APP }}"
          exit 1
          exit 1